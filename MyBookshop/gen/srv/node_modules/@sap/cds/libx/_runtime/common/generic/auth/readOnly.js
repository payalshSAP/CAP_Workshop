const cds = require('../../../cds')
const { getAuthRelevantEntity } = require('./utils')
const { WRITE_EVENTS } = require('./constants')

function handler(req) {
  // @read-only
  let entity = getAuthRelevantEntity(req, this.model, ['@readonly'])
  if (cds.env.fiori.lean_draft) entity = entity?.actives || entity

  if (!entity || !entity['@readonly']) return
  if (entity['@readonly'] && req.event in WRITE_EVENTS) req.reject(405, 'ENTITY_IS_READ_ONLY', [entity.name])
}

handler._initial = true

module.exports = handler
